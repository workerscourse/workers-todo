<!DOCTYPE html>
<html lang="en" x-data="data()" x-init="getTasks()">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Tasks</title>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@2.8.1/dist/alpine.min.js"
      defer
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/base.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/components.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@tailwindcss/typography@0.4.0/dist/typography.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@tailwindcss/forms@0.2.1/dist/forms.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/utilities.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="min-h-screen bg-gray-50">
      <main class="py-6 lg:py-8">
        <div class="py-16 px-4 overflow-hidden sm:px-6 lg:px-8 lg:py-24">
          <div class="relative max-w-xl mx-auto">
            <div class="space-y-6">
              <div class="sm:col-span-2">
                <label
                  for="question"
                  class="block text-sm font-medium text-gray-700"
                >
                  New Task
                </label>

                <div class="mt-1">
                  <input
                    type="text"
                    name="task"
                    x-model="newTask"
                    placeholder="Publish repository on GitHub"
                    class="py-3 px-4 block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-300 border-gray-300 rounded-md"
                    @keyup.enter="createTask(newTask)"
                  />
                </div>
              </div>

              <div>
                <label
                  for="answer1"
                  class="block text-sm font-medium text-gray-700"
                >
                  My Tasks
                </label>
                <div class="mt-1 bg-white overflow-hidden shadow rounded-lg">
                  <div class="px-4 py-5 sm:p-6">
                    <div class="space-y-4 -mt-4">
                      <template x-for="task in tasks">
                        <div class="flex space-x-4 items-center">
                          <!-- Text input -->
                          <input
                            type="checkbox"
                            x-model="task.completed"
                            :checked="task.completed"
                            class="flex-shrink-0 focus:ring-indigo-500 h-6 w-6 text-indigo-600 border-gray-300"
                            @change="completeTask(task.id, task.completed)"
                          />
                          <input
                            type="text"
                            x-model="task.task"
                            :value="task.task"
                            :disabled="task.completed"
                            :class="{ 'line-through text-gray-400': task.completed }"
                            class="focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm placeholder-gray-300 border-white rounded-md"
                            @blur="editTask(task.id, task.task)"
                            @keyup.enter="$event.target.blur()"
                          />
                        </div>
                      </template>
                      <template x-if="tasks.length === 0">
                        <div class="flex space-x-2 items-center">
                          <!-- Text input -->
                          <input
                            type="checkbox"
                            disabled
                            class="flex-shrink-0 focus:ring-indigo-500 h-6 w-6 text-indigo-600 border-gray-100"
                          />
                          <input
                            type="text"
                            disabled="task.completed"
                            placeholder="Add a task to get started"
                            class="focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm placeholder-gray-300 border-white rounded-md"
                          />
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      function data() {
        return {
          newTask: "",
          email: new URL(location).pathname.substr(1),
          tasks: [],
          getTasks() {
            fetch(
              `https://todo.workerscourse.workers.dev/api/todos/${this.email}`
            )
              .then((res) => res.json())
              .then((data) => {
                this.tasks = data.tasks;
              });
          },
          createTask(task) {
            if (task) {
              fetch(
                `https://todo.workerscourse.workers.dev/api/todos/${this.email}`,
                {
                  method: "POST",
                  body: JSON.stringify({ task }),
                  headers: {
                    "content-type": "application/json",
                  },
                }
              )
                .then((res) => res.json())
                .then((data) => {
                  this.tasks.unshift(data.task);
                });
              this.newTask = "";
            }
          },
          editTask(id, task) {
            if (task) {
              fetch(
                `https://todo.workerscourse.workers.dev/api/todos/${this.email}/${id}`,
                {
                  method: "PATCH",
                  body: JSON.stringify({ task }),
                  headers: {
                    "content-type": "application/json",
                  },
                }
              );
            }
          },
          completeTask(id, completed) {
            fetch(
              `https://todo.workerscourse.workers.dev/api/todos/${this.email}/${id}`,
              {
                method: "PATCH",
                body: JSON.stringify({ completed }),
                headers: {
                  "content-type": "application/json",
                },
              }
            );
          },
        };
      }

      //   function createTask() {
      //     if (newTask) {
      //       fetch(`https://todo.workerscourse.workers.dev/api/todos/${email}`, {
      //         method: "POST",
      //         body: JSON.stringify({ task: newTask }),
      //         headers: {
      //           "content-type": "application/json",
      //         },
      //       })
      //         .then((res) => res.json())
      //         .then((data) => {
      //           tasks.unshift(data.task);
      //         });
      //       newTask = "";
      //     }
      //   }
      //   editTask = (id, edit) => {
      //     console.log(id, edit);
      //     if (edit) {
      //       fetch(
      //         `https://todo.workerscourse.workers.dev/api/todos/${this.email}/${id}`,
      //         {
      //           method: "PATCH",
      //           body: JSON.stringify({ task: edit }),
      //           headers: {
      //             "content-type": "application/json",
      //           },
      //         }
      //       );
      //     }
      //   };
      //   window.completeTask = (id, completed) => {
      //     fetch(
      //       `https://todo.workerscourse.workers.dev/api/todos/${email}/${id}`,
      //       {
      //         method: "PATCH",
      //         body: JSON.stringify({ completed }),
      //         headers: {
      //           "content-type": "application/json",
      //         },
      //       }
      //     );
      //   };
    </script>
  </body>
</html>
